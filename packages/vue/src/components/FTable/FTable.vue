<script setup lang="ts" generic="T extends Record<string, unknown>, K extends keyof T">
import { computed, onMounted, provide, type Ref, ref, useTemplateRef } from "vue";
import { assertRef } from "@fkui/logic";
import { setInternalKeys } from "../../utils/internal-key";
import FIcon from "../FIcon/FIcon.vue";
import FTextField from "../FTextField/FTextField.vue";
import {
    getMetaRows,
    maybeNavigateToCell,
    setDefaultCellTarget as setDefaultCellTarget,
    switchTabbable,
    stopEdit,
    setTabbable,
    getTd,
} from "./FTable.logic";
import ITableRow from "./ITableRow.vue";
import { TableColumn } from "./table-column";
import FTableCell from "./FTableCell.vue";
import FTableEditCell from "./FTableEditCell.vue";

const {
    columns,
    rows,
    keyAttribute = undefined,
    expandableAttribute = undefined,
    striped = false,
} = defineProps<{
    columns: Array<TableColumn<T, K>>;
    rows: T[];
    keyAttribute?: K;
    expandableAttribute?: K;
    striped?: boolean;
}>();

const tableRef = useTemplateRef("table");
const expandedKeys: Ref<string[]> = ref([]);
const keyedRows = computed(() => setInternalKeys(rows, keyAttribute, expandableAttribute));
const metaRows = computed(() => getMetaRows(keyedRows.value, expandedKeys.value, expandableAttribute));
const isTreegrid = computed(() => Boolean(expandableAttribute));
const role = computed(() => (isTreegrid.value ? "treegrid" : "grid"));

const tableClasses = computed(() => {
    return striped ? "table-ng table-ng--striped" : "table-ng";
});

/**
 * Current td or action (e.g. button) element.
 * Tabbable when not in edit mode.
 * May be focused when not in edit mode.
 */
const currentCellTarget: Ref<HTMLElement | null> = ref(null);

async function startEditHandler(focusElement: HTMLElement): Promise<void> {
    assertRef(currentCellTarget);
    setTabbable(currentCellTarget.value, false);
    currentCellTarget.value = getTd(focusElement);

    focusElement.focus();
}

async function stopEditHandler(reason: "enter" | "escape" | "tab" | "shift-tab" | "blur"): Promise<void> {
    assertRef(tableRef);
    assertRef(currentCellTarget);
    currentCellTarget.value = stopEdit(tableRef.value, currentCellTarget.value, reason);
}

provide("startEdit", startEditHandler);
provide("stopEdit", stopEditHandler);

function onToggleExpanded(key: string): void {
    const index = expandedKeys.value.indexOf(key);

    if (index < 0) {
        expandedKeys.value.push(key);
    } else {
        expandedKeys.value.splice(index, 1);
    }
}

function onKeydown(e: KeyboardEvent): void {
    assertRef(tableRef);
    assertRef(currentCellTarget);
    currentCellTarget.value = maybeNavigateToCell(e, tableRef.value, currentCellTarget.value);
}

function onClick(e: MouseEvent): void {
    const newCellTarget = e.target as HTMLElement;
    switchTabbable(newCellTarget, currentCellTarget.value);
    currentCellTarget.value = newCellTarget;
    currentCellTarget.value.focus();
}

onMounted(() => {
    assertRef(tableRef);
    currentCellTarget.value = setDefaultCellTarget(tableRef.value);
});
</script>

<template>
    <table ref="table" :role :class="tableClasses">
        <thead>
            <tr class="table-ng__row">
                <th v-if="isTreegrid" tabindex="-1" class="table-ng__column"></th>
                <th v-for="column in columns" :key="column.header" scope="col" class="table-ng__column">
                    {{ column.header }}
                </th>
            </tr>
        </thead>

        <tbody @click="onClick" @keydown="onKeydown">
            <!-- [html-validate-disable-next element-permitted-content -- transparent tr] -->
            <i-table-row
                v-for="{ key, row, rowIndex, level, setsize, posinset, isExpandable, isExpanded } in metaRows"
                :key
                :row-key="key"
                :aria-rowindex="rowIndex"
                :aria-level="level"
                :aria-setsize="setsize"
                :aria-posinset="posinset"
                :is-treegrid
                :is-expandable
                :is-expanded
                @toggle="onToggleExpanded"
            >
                <template v-for="column in columns" :key="column.header">
                    <template v-if="column.type === 'checkbox'">
                        <f-table-cell :title="column.header">
                            <input v-model="row[column.key!]" type="checkbox" :aria-label="column.header" />
                        </f-table-cell>
                    </template>
                    <template v-else-if="column.type === 'text'">
                        <template v-if="column.editable">
                            <f-table-edit-cell title="Redigerbar text">
                                <f-text-field
                                    v-model="row[column.key!]"
                                    v-validation.required
                                    class="table-input"
                                    maxlength="40"
                                ></f-text-field>
                            </f-table-edit-cell>
                        </template>
                        <template v-else>
                            <f-table-cell title="Kryssruta">
                                {{ column.key ? row[column.key] : column.value!(row) }}
                            </f-table-cell>
                        </template>
                    </template>
                    <template v-else-if="column.type === 'anchor'">
                        <f-table-cell title="LÃ¤nk">
                            <a class="anchor anchor--block" target="_blank" :href="column.href"
                                >{{ column.value(row) }}
                            </a>
                        </f-table-cell>
                    </template>
                    <template v-else-if="column.type === 'button'">
                        <f-table-cell title="Knapp">
                            <button class="icon-button" type="button" @click="column.onClick!(column.value(row))">
                                <f-icon name="trashcan"></f-icon>
                                <span class="sr-only">Knapptext</span>
                            </button>
                        </f-table-cell>
                    </template>
                    <template v-else-if="column.type === 'render'">
                        <component :is="column.render()" :row></component>
                    </template>
                </template>
            </i-table-row>
        </tbody>
    </table>
</template>
