name: Artifact size

on:
    pull_request:
        types: [opened, synchronize, reopened]

permissions:
    contents: read

jobs:
    analyze-base:
        name: Analyze (base)
        runs-on: ubuntu-latest
        steps:
            - name: Checkout target branch
              uses: actions/checkout@v6
              with:
                  ref: ${{ github.event.pull_request.base.ref }}
            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 22.x
            - name: Install dependencies
              run: npm ci
            - name: Build
              run: npm run build
            - name: Run analyzer
              uses: ext/artifact-size-analyzer/analyze@v1
              with:
                  config-file: .github/artifact-size.json
                  artifact-name: base-size

    analyze-current:
        name: Analyze (current)
        runs-on: ubuntu-latest
        steps:
            - name: Checkout head ref
              uses: actions/checkout@v6
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 22.x
            - name: Install dependencies
              run: npm ci
            - name: Build
              run: npm run build
            - name: Run analyzer (current)
              uses: ext/artifact-size-analyzer/analyze@v1
              with:
                  config-file: .github/artifact-size.json
                  artifact-name: current-size

    compare:
        name: Compare
        permissions:
            contents: read
            pull-requests: write
        runs-on: ubuntu-latest
        needs: [analyze-base, analyze-current]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 22.x
            - name: Install dependencies
              run: npm ci
            - name: Compare results
              id: compare
              uses: ext/artifact-size-analyzer/compare@main
              with:
                  base-artifact: base-size
                  current-artifact: current-size
            - name: Post sticky PR comment
              uses: marocchino/sticky-pull-request-comment@v2
              with:
                  header: artifact-size-analyzer
                  message: |
                      ${{ steps.compare.outputs.markdown }}
